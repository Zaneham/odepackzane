name: CI
on: [push, pull_request]
jobs:

  # ARM Testing - Apple Silicon
  Build-ARM:
    runs-on: macos-14
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup environment
      run: |
        brew install gcc fpm
        which gfortran-14 || ls /opt/homebrew/bin/gfortran*

    - name: Compile and Test (ARM64)
      run: |
        export FC=gfortran-14
        fpm build --flag "-std=legacy -fallow-argument-mismatch"
        fpm test --flag "-std=legacy -fallow-argument-mismatch"

  # RISC-V Testing via QEMU
  Build-RISCV:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static gfortran-12-riscv64-linux-gnu
        sudo update-alternatives --install /usr/bin/riscv64-linux-gnu-gfortran riscv64-linux-gnu-gfortran /usr/bin/riscv64-linux-gnu-gfortran-12 100

    - name: Setup fpm
      run: |
        wget -q https://github.com/fortran-lang/fpm/releases/download/v0.6.0/fpm-0.6.0-linux-x86_64 -O fpm
        chmod +x fpm
        sudo mv fpm /usr/local/bin/

    - name: Compile and Test (RISC-V)
      run: |
        export FC=riscv64-linux-gnu-gfortran
        fpm build --flag "-std=legacy -fallow-argument-mismatch -static"
        fpm test --flag "-std=legacy -fallow-argument-mismatch -static" --runner qemu-riscv64-static

  # x86_64 Linux
  Build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gfortran-10 python3-pip graphviz
        pip install ford numpy matplotlib

    - name: Setup fpm
      run: |
        wget -q https://github.com/fortran-lang/fpm/releases/download/v0.6.0/fpm-0.6.0-linux-x86_64 -O fpm
        chmod +x fpm
        sudo mv fpm /usr/local/bin/

    - name: Compile and Test
      run: |
        export FC=gfortran-10
        fpm build --flag "-std=legacy -fallow-argument-mismatch"
        fpm test --flag "-std=legacy -fallow-argument-mismatch"

    - name: Build documentation
      run: ford ./ford.md

    - name: Deploy Documentation
      if: github.ref == 'refs/heads/master'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: docs/fpm-ford
